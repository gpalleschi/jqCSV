<html lang="en">

    <!-- jqCSV ver 1.0 25/06/2021 by Giovanni Palleschi
         This project is licensed under the GNU GENERAL PUBLIC LICENSE 3.0 License  
    -->

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>jqCSV</title>
        <!--link href="CSS/jqCSV.css" rel="stylesheet"/-->
        <script src="js/jquery-3.6.0.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/bootstrap-table.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
        <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script> 
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table-locale-all.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/export/bootstrap-table-export.min.js"></script>
        <link href="css/jqCSV.css" rel="stylesheet">

        <script>

            $(document).ready(function () {

                function getIdSelections() {
                    return $.map($("#table").bootstrapTable('getSelections'), function (row) {
                        return row.id
                    })
                }

                function responseHandler(res) {
                    $.each(res.rows, function (i, row) {
                        row.state = $.inArray(row.id, selections) !== -1
                    })
                    return res
                }

                function detailFormatter(index, row) {
                    var html = []
                    $.each(row, function (key, value) {
                        html.push('<p><b>' + key + ':</b> ' + value + '</p>')
                    })
                    return html.join('')
                }

                function operateFormatter(value, row, index) {
                    return [
                        '<a class="edit" href="javascript:void(0)" title="Edit">',
                        '<i class="fa fa-edit"></i>',
                        '</a>  ',
                        '<a class="remove" href="javascript:void(0)" title="Remove">',
                        '<i class="fa fa-trash"></i>',
                        '</a>'
                    ].join('')
                }


                window.operateEvents = {
                    'click .edit': function (e, value, row, index) {
                        $(".modal-title").text('Row Detail');
                        var formToShow = '<form>'
                        var ind=1;
                        for(var key in row){
                            if ( key == 'state' ) continue;
                            formToShow = formToShow + '<div class="form-group row">';
                            formToShow = formToShow + '<label id="ModalHeader_' + ind + '" for="' + key + '" class="col-sm-2 col-form-label">' + key + '</label><div class="col-sm-10">';
                            if ( key == 'id' ) {
                               formToShow = formToShow + '<input type="text" class="form-control" id="ModalField_' + ind + '" placeholder="' + key + '" value="' + index + '" readonly';
                            }    
                            else {
                               formToShow = formToShow + '<input type="text" class="form-control" id="ModalField_' + ind + '" placeholder="' + key + '" value="' + row[key] + '" ';
                            }
                            formToShow = formToShow + '>';
                            formToShow = formToShow + '</div></div>';
                            ind += 1;
                        }    
                        formToShow = formToShow + '<form>';

                        $('#detailsModal').modal('show')
                        .find('.modal-body').html(formToShow);
                    },
                    'click .remove': function (e, value, row, index) {
                        $table.bootstrapTable('remove', {
                            field: 'id',
                            values: [row.id]
                        })
                        }
                }

                function totalTextFormatter(data) {
                    return 'Total'
                }

                function totalNameFormatter(data) {
                    return data.length
                }

                function totalPriceFormatter(data) {
                    var field = this.field
                    return '$' + data
                        .map(function (row) {
                            return + row[field].substring(1)
                        })
                        .reduce(function (sum, i) {
                            return sum + i
                        }, 0)
                }

                // Function sum numeric fields
                function totalNumFormatter(data) {
                    var field = this.field
                    return data
                        .map(function (row) {
                            var valueField = row[field].replace(',','.');;
                            if ( $.isNumeric(valueField) == false ) return + '0';
                            return + valueField 
                        })
                        .reduce(function (sum, i) {
                            return sum + i;
                        }, 0)
                }

                function initTable(colsHeaders) {
                    $table.bootstrapTable('destroy');
                    $table.bootstrapTable({height: 550, locale: 'en-US', columns: colsHeaders, onRefresh: function(params) { loadFileCSV() }});
                    $table.on(
                        'check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table',
                        function () {
                            $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)

                            // save your data, here just save the current page
                            selections = getIdSelections()
                            // push or splice the selections if you want to save all data selections
                        }
                    )

                    $table.on('all.bs.table', function (e, name, args) {
                        //console.log(name, args)
                    })
                    $remove.click(function () {
                        var ids = getIdSelections()
                        $table.bootstrapTable('remove', {
                            field: 'id',
                            values: ids
                        })
                        $remove.prop('disabled', true)
                    })
                }

                function changeFileCSV(e) {
                    currentFileCSV = e.target.files.item(0);
                    loadFileCSV(e);
                }

                function bootstrap_alert(type, message) {
                    var typeAlert;
                    switch (type) {
                           case 'w':
                               typeAlert = 'alert-warning';
                               break;
                           case 'e':
                               typeAlert = 'alert-danger';
                               break;
                           default:
                               typeAlert = 'alert-danger';
                               break;
                    }

                    $('#alert_placeholder').html('<div class="alert ' + typeAlert + ' alert-dismissible fade show" role="alert"><strong>' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                }

                function loadFileCSV(e) {
                    var ext = $("input#filename")
                        .val()
                        .split(".")
                        .pop()
                        .toLowerCase();

                    if ($.inArray(ext, ["csv"]) == -1) {
                        bootstrap_alert('e','Error file with no csv extension.');
                        $("#filename").val('');
                        return false;
                    }

                    $table.bootstrapTable('destroy');
                    // Filter rules
                    if ($.trim($("#filter").val()) != "") {
                        colsToFilter = $("#filter")
                            .val()
                            .split(",");
                        for (x = 0; x < colsToFilter.length; x++) {
                            fieldExpr = colsToFilter[x].split(":");
                            if ($.isNumeric(fieldExpr[0]) == false && fieldExpr[0] != '#') {
                                // Range Value
                                rangeValue = fieldExpr[0].split("-");
                                if ( rangeValue.length != 2 ) {
                                   bootstrap_alert('e','Error in Filter value ' + fieldExpr[0] + " is not numeric.");
                                   $("#filename").val('');
                                   return;
                                } else {
                                    if ( $.isNumeric(rangeValue[0]) == false || $.isNumeric(rangeValue[0]) == false ) {
                                       bootstrap_alert('e','Error Range value ' + fieldExpr[0] + " is not numeric.");
                                       $("#filename").val('');
                                       return;
                                    } else {
                                        if ( parseInt(rangeValue[0]) > parseInt(rangeValue[1]) ) {
                                           bootstrap_alert('e','Error Range value from ' + rangeValue[0] + " is greater than Range value to " + rangeValue[1] + ".");
                                           $("#filename").val('');
                                           return;
                                        }

                                        for(k=parseInt(rangeValue[0]);k<=parseInt(rangeValue[1]); k++) {
                                            if (fieldExpr.length > 1) {
                                                mapCols.set(k,fieldExpr[1]);
                                            } else {
                                                mapCols.set(k,"NoExpr");
                                            }
                                        }
                                    }
                                }
                            } else {
                                if ( fieldExpr[0] != '#' ) {
                                    if (fieldExpr.length > 1) {
                                        mapCols.set(parseInt(fieldExpr[0]),fieldExpr[1]);
                                    } else {
                                        mapCols.set(parseInt(fieldExpr[0]),"NoExpr");
                                    }
                                } else {
                                    if (fieldExpr.length > 1) {
                                        mapCols.set('#',fieldExpr[1]);
                                    } else {
                                        mapCols.set('#',"NoExpr");
                                    }
                                }
                            }
                        }
                    }

                    // Reading CSV file
                    var reader = new FileReader();
                    var header = $('#isHeader').is(":checked");
                    var headerFieldsI = [];
                    var headerFieldsT = [];
                    var headerFields = [];
                    var headerNames = [];
                    var dataFields = [];

                    reader.onload = function (e) {
                        var lines = e
                            .target
                            .result
                            .split('\r\n');

                        var lineNum = 0;
                        var noHeader = false;
                        var fields;

                        headerFieldsT = [];
                        headerFields = [];
                        dataFields = [];
                        headerNames = [];
                        headerFieldsT.push(
                            {field: 'state', checkbox: true, align: 'center', valign: 'middle',footerFormatter: totalTextFormatter}
                        );
                        headerFieldsT.push(
                            { title: 'Item ID', field: 'id', align: 'center', valign: 'middle', sortable: true, footerFormatter: totalNameFormatter }
                        );
                        var rows = [];

                        for (i = 0; i < lines.length; ++i) {
                            // Check if present # (check regexpr on line)
                            if (mapCols.size > 0 && (mapCols.has('#'))) {
                                if ( mapCols.get('#') != 'NoExpr' ) {
                                   var exprLine = RegExp(mapCols.get('#'));
                                   if ( exprLine.test(lines[i]) == false ) continue;
                                }
                            } 


                            fields = lines[i].split(sep);
                            var fieldNum = 1;
                            // Header
                            if (noHeader == false) {
                                if (header == true) {
                                    fields = lines[0].split(sep);
                                    lineNum = 1;
                                    for (y = 0; y < fields.length; y++) {
                                        if ( mapCols.size > 0 ) {
                                            // Caso con solo filtro
                                            if ( (mapCols.size == 1 && (mapCols.has('#') == false)) || mapCols.size > 1 ) {
                                               if ( (mapCols.has(y+1)) == false ) continue;
                                            }
                                        }
                                        if ( mapCols.get(y+1) == 'C') {
                                            headerFieldsT.push(
                                                {field: fields[y], title: fields[y], footerFormatter: totalNumFormatter, sortable: true, align: 'center'}
                                            );
                                        } else {
                                            headerFieldsT.push(
                                                {field: fields[y], title: fields[y], sortable: true, align: 'center'}
                                            );
                                        }
                                        headerNames.push(fields[y]);
                                    }
                                } else {
                                    for (y = 0; y < fields.length; y++) {
                                        if ( mapCols.size > 0 ) {
                                            // Caso con solo filtro
                                            if ( (mapCols.size == 1 && (mapCols.has('#') == false)) || mapCols.size > 1 ) {
                                               if ( (mapCols.has(y+1)) == false ) continue;
                                            }
                                        }
                                        if ( mapCols.get(y+1) == 'C') {
                                            headerFieldsT.push(
                                                { field: 'Field_' + fieldNum, title: 'Field ' + fieldNum, footerFormatter: totalNumFormatter, sortable: true, align: 'center' }
                                            );
                                        } else {
                                            headerFieldsT.push(
                                                { field: 'Field_' + fieldNum, title: 'Field ' + fieldNum, sortable: true, align: 'center' }
                                            );
                                        }
                                        headerNames.push('Field_' + fieldNum);
                                        fieldNum += 1;
                                    }
                                }
                                headerFieldsT.push(
                                { field: 'operate', title: 'Item Operate', align: 'center', clickToSelect: false, events: window.operateEvents, formatter: operateFormatter }
                                            );

                                headerFields.push(headerFieldsT);
                                initTable(headerFields);
                                $table.bootstrapTable('showLoading');

                                noHeader = true;


                                if (header == true && i == 0) 
                                    continue;
                            }
                            
                            // Body
                            lineNum += 1;
                            var data = {};
                            data['id'] = lineNum;
                            var colNum=0;
                            var discRow = false;
                            fields = lines[i].split(sep);
                            for (y = 0; y < fields.length; y++) {
                                if ( mapCols.size > 0 ) {
                                     // Caso con solo filtro
                                     if ( (mapCols.size == 1 && (mapCols.has('#') == false)) || mapCols.size > 1 ) {
                                          if ( (mapCols.has(y+1) == false) ) continue;
                                     }
                                     if ( mapCols.get(y+1) != 'NoExpr' && mapCols.get(y+1) != 'C' ) {
                                        var exprField = RegExp(mapCols.get(y+1));
                                        if ( exprField.test(fields[y]) == false ) {
                                           discRow = true;
                                           break;
                                        }    
                                     }
                                }
                                data[headerNames[colNum]] = fields[y];
                                colNum+=1;
                            }

                            if ( discRow == false && fields.length > 1 ) rows.push(data);
                        }
                        $table.bootstrapTable('load', rows);
                        $table.bootstrapTable('hideLoading');
                        $remove.removeAttr('hidden');    
                        $('#insert').removeAttr('hidden');    
                        mapCols.clear();
                    };
                    //reader.readAsText(e.target.files.item(0));
                    reader.readAsText(currentFileCSV);
                    return false;
                }

                var currentFileCSV;
                var $table = $('#table');
                var $remove = $('#remove');
                var selections = [];
                var sep = ';';
                var row = [];
                var mapCols = new Map();

                $("#separator").change(function () {
                    sep = $("#separator").val();
                });

                $("#filename").change(changeFileCSV);

                // Close Modal
                $("#closeModal,.close").click(function() {
                    $('#detailsModal').modal('hide');
                });

                // Save Modal
                $("#saveModal").click(function() {

                    var data = {};
                    var idxElem;
                    var row;
                    var bUpdate = false;
                    if ( $(".modal-title").text() == 'Row Detail') {
                        bUpdate = true;
                    }
                    
                    if ( bUpdate ) {
                       idxElem = $('#ModalField_1').val();
                       row = $table.bootstrapTable('getData')[idxElem];
                    } else {
                       idxElem = $('#ModalField_1').val();
                       if ( idxElem > $('#table').bootstrapTable('getOptions').totalRows + 1 ) {
                          idxElem =  $('#table').bootstrapTable('getOptions').totalRows;
                       } else {
                         idxElem = $('#ModalField_1').val() - 1;
                       }
                       row = $table.bootstrapTable('getData')[0];
                    }

                    var idxNewVal = 0;
                    for(var key in row){
                        idxNewVal = idxNewVal + 1;
                        if ( key == 'state' ) continue;
                        if ( key == 'id' && bUpdate ) continue;
                        if ( key == 'id' ) {
                          data[key] = $('#table').bootstrapTable('getOptions').totalRows + 1;
                        } else {
                          data[key] = $('#ModalField_' + idxNewVal).val();
                        }
                    }        
                    if ( bUpdate ) {
                       $table.bootstrapTable('updateRow', { index: idxElem, row: data });
                    } else {
                       $table.bootstrapTable('insertRow', { index: idxElem, row: data });
                       $table.bootstrapTable('scrollTo', {unit: 'rows', value: idxElem});
                    }

                    $('#detailsModal').modal('hide');
                });

                // New Row
                $("#insert").click(function() {
                        $(".modal-title").text('New Row');
                        var formToShow = '<form>'
                        var ind=1;

                        var row = $table.bootstrapTable('getData')[0];
                        var newIdx = $('#table').bootstrapTable('getOptions').totalRows + 1;

                        for(var key in row){
                            if ( key == 'state' ) continue;
                            formToShow = formToShow + '<div class="form-group row">';
                            formToShow = formToShow + '<label id="ModalHeader_' + ind + '" for="' + key + '" class="col-sm-2 col-form-label">' + key + '</label><div class="col-sm-10">';
                            if ( key == 'id' ) {
                                formToShow = formToShow + '<input type="number" class="form-control" min="1" max="1000000000" id="ModalField_' + ind + '" placeholder="' + key + '" value="' + newIdx + '">';
                            } else {    
                                formToShow = formToShow + '<input type="text" class="form-control" id="ModalField_' + ind + '" placeholder="' + key + '">';
                            }
                            formToShow = formToShow + '</div></div>';
                            ind += 1;
                        }    
                        formToShow = formToShow + '<form>';

                        $('#detailsModal').modal('show')
                        .find('.modal-body').html(formToShow);
                });
            });
        </script>
    </head>

    <body>
        <header class="d-flex justify-content-center">
            <h1
                class="display-1 text-center border border-dark rounded text-white m-3 p-3 pt-0 w-25"
                style="background-color: #6c757d;">jqCSV</h1>
        </header>

        <!--div class="container"-->
        <div class="container">
            <div class="row">
                <div class="col-sm-8">
                    <input type="file" class="form-control px-3 mb-3" id="filename"/>
                </div>

                <div class="col-sm-1 w-4">
                    <select class="form-select" aria-label="Default select example" id="separator">
                        <option selected="selected">
                            ;
                        </option>
                        <option value="|">
                            |
                        </option>
                        <option value=",">
                            ,
                        </option>
                        <option value=".">
                            .
                        </option>
                        <option value=":">
                            :
                        </option>
                    </select>
                </div>

                <div class="col-sm-2">
                    <input
                        class="form-check-input align-middle"
                        style="background-color: #6c757d"
                        type="checkbox"
                        value=""
                        id="isHeader">
                    <label
                        class="form-check-label align-middle"
                        style="font-weight: bold;"
                        for="flexCheckChecked">Header</label>
                </div>

            </div>
            <div class="row">
                <div class="col-sm-10">
                    <input id="filter" class="form-control px-3 mb-3" type="text" data-toggle="tooltip" data-placement="right" title="Filter Expression (field Number):(Regular expression or C for sum columns values)">
                    <div id = "alert_placeholder"></div>
                </div>
                <div class="col-sm-1"></div>
            </div>
        </div>

        <div id="toolbar">
            <button id="remove" class="btn btn-danger" disabled="disabled" hidden style="background-color: #6c757d;">
                <i class="fa fa-trash"></i>
                Delete
            </button>
            <button id="insert" class="btn btn-primary" hidden style="background-color: #6c757d;">
                <i class="fa fa-insert"></i>
                New Row
            </button>
        </div>

        <hr
            style="border: 10px solid rgb(108, 117, 125); border-radius: 5px; margin-right: 50px; margin-left: 50px;">
        <div class="container-fluid">
        <table
            id="table"
            data-toolbar="#toolbar"
            data-search="true"
            data-show-refresh="true"
            data-show-toggle="true"
            data-show-fullscreen="false"
            data-show-columns="true"
            data-show-columns-toggle-all="true"
            data-detail-view="false"
            data-show-export="true"
            data-click-to-select="true"
            data-detail-formatter="detailFormatter"
            data-minimum-count-columns="2"
            data-show-pagination-switch="true"
            data-pagination="true"
            data-id-field="id"
            data-page-list="[10, 25, 50, 100, all]"
            data-show-footer="true"
            data-side-pagination="client"
            data-response-handler="responseHandler"></table>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Row Detail</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button id="closeModal" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="saveModal" type="button" class="btn btn-primary">Save changes</button>
            </div>
            </div>
        </div>
        </div>

    </body>

</html>